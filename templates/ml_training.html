{% extends 'base.html' %}

{% block title %}ML Training Dashboard{% endblock %}

{% block styles %}
<style>
    .status-card {
        transition: transform 0.3s ease, box-shadow 0.3s ease;
    }
    .status-card:hover {
        transform: translateY(-5px);
        box-shadow: 0 10px 20px rgba(0,0,0,0.1);
    }
    .training-progress {
        height: 8px;
        margin-top: 8px;
    }
    .stats-container {
        font-size: 0.9rem;
    }
    .batch-item {
        transition: background-color 0.2s ease;
    }
    .batch-item:hover {
        background-color: #f8f9fa;
    }
    .section-label {
        font-size: 0.8rem;
        text-transform: uppercase;
        letter-spacing: 1px;
        color: #6c757d;
    }
    .chart-container {
        height: 300px;
    }
    .batch-badge {
        width: 30px;
        display: inline-block;
        text-align: center;
    }
    .dropzone {
        border: 2px dashed #dee2e6;
        padding: 2rem;
        text-align: center;
        cursor: pointer;
        transition: all 0.3s ease;
    }
    .dropzone:hover, .dropzone.dragover {
        background-color: #f8f9fa;
        border-color: #007bff;
    }
    .document-badge {
        font-size: 0.7rem;
        padding: 0.2rem 0.4rem;
    }
</style>
{% endblock %}

{% block content %}
<div class="container-fluid py-4">
    <div class="row mb-4">
        <div class="col-md-8">
            <h1 class="display-5 mb-0">ML Training Dashboard</h1>
            <p class="text-muted">Manage and optimize your machine learning models</p>
        </div>
        <div class="col-md-4 text-end">
            <a href="{{ url_for('regulatory.ml_insights') }}" class="btn btn-outline-secondary me-2">
                <i class="fas fa-chart-line me-1"></i> View Insights
            </a>
            <button type="button" class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#newTrainingModal">
                <i class="fas fa-plus me-1"></i> New Training Session
            </button>
        </div>
    </div>
    
    <!-- Flash Messages -->
    {% with messages = get_flashed_messages() %}
        {% if messages %}
            {% for message in messages %}
                <div class="alert alert-info alert-dismissible fade show mb-4">
                    {{ message }}
                    <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                </div>
            {% endfor %}
        {% endif %}
    {% endwith %}
    
    <!-- Training Status Cards -->
    <div class="row mb-4">
        <div class="col-md-3">
            <div class="card status-card shadow-sm h-100">
                <div class="card-body">
                    <h5 class="card-title text-muted mb-0">Training Sessions</h5>
                    <div class="d-flex justify-content-between align-items-center">
                        <h2 class="display-4 mb-0">{{ ml_stats.total_sessions }}</h2>
                        <i class="fas fa-laptop-code text-primary fa-2x"></i>
                    </div>
                    <p class="text-muted mt-2">
                        <i class="fas fa-calendar-alt me-1"></i> Last on {{ ml_stats.last_session_date|default('Never') }}
                    </p>
                </div>
            </div>
        </div>
        
        <div class="col-md-3">
            <div class="card status-card shadow-sm h-100">
                <div class="card-body">
                    <h5 class="card-title text-muted mb-0">Documents Processed</h5>
                    <div class="d-flex justify-content-between align-items-center">
                        <h2 class="display-4 mb-0">{{ ml_stats.total_documents }}</h2>
                        <i class="fas fa-file-alt text-success fa-2x"></i>
                    </div>
                    <p class="text-muted mt-2">
                        <i class="fas fa-database me-1"></i> {{ ml_stats.document_types|default(1) }} different document types
                    </p>
                </div>
            </div>
        </div>
        
        <div class="col-md-3">
            <div class="card status-card shadow-sm h-100">
                <div class="card-body">
                    <h5 class="card-title text-muted mb-0">Current Accuracy</h5>
                    <div class="d-flex justify-content-between align-items-center">
                        <h2 class="display-4 mb-0">{{ "%.1f"|format(ml_stats.current_accuracy|default(0)) }}%</h2>
                        <i class="fas fa-bullseye text-danger fa-2x"></i>
                    </div>
                    <div class="progress training-progress">
                        <div class="progress-bar bg-success" role="progressbar" style="width: {{ ml_stats.current_accuracy|default(0) }}%" 
                             aria-valuenow="{{ ml_stats.current_accuracy|default(0) }}" aria-valuemin="0" aria-valuemax="100"></div>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="col-md-3">
            <div class="card status-card shadow-sm h-100">
                <div class="card-body">
                    <h5 class="card-title text-muted mb-0">Current Status</h5>
                    <div class="d-flex justify-content-between align-items-center">
                        {% if ml_stats.is_training %}
                        <h2 class="text-warning display-4 mb-0">Training</h2>
                        <i class="fas fa-spinner fa-spin text-warning fa-2x"></i>
                        {% else %}
                        <h2 class="text-success display-4 mb-0">Ready</h2>
                        <i class="fas fa-check-circle text-success fa-2x"></i>
                        {% endif %}
                    </div>
                    <p class="text-muted mt-2">
                        {% if ml_stats.is_training %}
                        <i class="fas fa-clock me-1"></i> Started {{ ml_stats.training_start_time|default('recently') }}
                        {% else %}
                        <i class="fas fa-check me-1"></i> System ready for training
                        {% endif %}
                    </p>
                </div>
            </div>
        </div>
    </div>
    
    <div class="row mb-4">
        <!-- Training History Chart -->
        <div class="col-md-8">
            <div class="card shadow-sm h-100">
                <div class="card-header bg-white d-flex justify-content-between align-items-center">
                    <h5 class="card-title mb-0">Training Progress</h5>
                    <div class="btn-group btn-group-sm">
                        <button type="button" class="btn btn-outline-secondary active" data-range="all">All Sessions</button>
                        <button type="button" class="btn btn-outline-secondary" data-range="recent">Recent</button>
                    </div>
                </div>
                <div class="card-body">
                    <div class="chart-container">
                        <canvas id="trainingHistoryChart"></canvas>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Statistics -->
        <div class="col-md-4">
            <div class="card shadow-sm h-100">
                <div class="card-header bg-white">
                    <h5 class="card-title mb-0">Training Statistics</h5>
                </div>
                <div class="card-body">
                    <div class="stats-container">
                        <div class="d-flex justify-content-between mb-3">
                            <span>Average batch size:</span>
                            <strong>{{ ml_stats.avg_batch_size|default(0) }}</strong>
                        </div>
                        <div class="d-flex justify-content-between mb-3">
                            <span>Average training time:</span>
                            <strong>{{ ml_stats.avg_training_time|default('0 min') }}</strong>
                        </div>
                        <div class="d-flex justify-content-between mb-3">
                            <span>Best validation accuracy:</span>
                            <strong class="text-success">{{ "%.1f"|format(ml_stats.best_validation|default(0)) }}%</strong>
                        </div>
                        <div class="d-flex justify-content-between mb-3">
                            <span>Last improvement:</span>
                            <strong>{{ ml_stats.last_improvement|default('Never') }}</strong>
                        </div>
                        <div class="d-flex justify-content-between mb-3">
                            <span>Optimal epochs:</span>
                            <strong>{{ ml_stats.optimal_epochs|default(0) }}</strong>
                        </div>
                        <div class="d-flex justify-content-between mb-3">
                            <span>Document types coverage:</span>
                            <strong>{{ ml_stats.coverage|default(0) }}%</strong>
                        </div>
                        <div class="d-flex justify-content-between mb-3">
                            <span>Framework coverage:</span>
                            <strong>{{ ml_stats.framework_coverage|default(0) }}%</strong>
                        </div>
                        <div class="d-flex justify-content-between">
                            <span>Model:</span>
                            <strong>{{ ml_stats.model_name|default('Standard') }}</strong>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Training Batches -->
    <div class="card shadow-sm mb-4">
        <div class="card-header bg-white d-flex justify-content-between align-items-center">
            <h5 class="card-title mb-0">Recent Training Batches</h5>
            <button class="btn btn-sm btn-primary" data-bs-toggle="modal" data-bs-target="#addDocumentsModal">
                <i class="fas fa-upload me-1"></i> Upload Training Documents
            </button>
        </div>
        <div class="list-group list-group-flush">
            {% for batch in training_batches %}
            <div class="list-group-item batch-item">
                <div class="row align-items-center">
                    <div class="col-md-1 text-center">
                        <span class="badge bg-primary rounded-pill batch-badge">{{ batch.id }}</span>
                    </div>
                    <div class="col-md-3">
                        <h6 class="mb-0">{{ batch.name }}</h6>
                        <small class="text-muted">{{ batch.date }}</small>
                    </div>
                    <div class="col-md-2">
                        <div class="d-flex">
                            <span class="me-2">{{ batch.documents }} documents</span>
                            <div class="document-types">
                                {% for type in batch.document_types %}
                                <span class="badge bg-light text-dark document-badge">{{ type }}</span>
                                {% endfor %}
                            </div>
                        </div>
                    </div>
                    <div class="col-md-2">
                        <div class="d-flex align-items-center">
                            <span class="me-2">{{ "%.1f"|format(batch.accuracy) }}%</span>
                            <div class="progress flex-grow-1" style="height: 5px;">
                                <div class="progress-bar 
                                    {% if batch.accuracy > 80 %}bg-success
                                    {% elif batch.accuracy > 60 %}bg-warning
                                    {% else %}bg-danger{% endif %}" 
                                    role="progressbar" 
                                    style="width: {{ batch.accuracy }}%;">
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-2">
                        <span class="badge 
                            {% if batch.status == 'Completed' %}bg-success
                            {% elif batch.status == 'In Progress' %}bg-warning
                            {% elif batch.status == 'Failed' %}bg-danger
                            {% else %}bg-secondary{% endif %}">
                            {{ batch.status }}
                        </span>
                    </div>
                    <div class="col-md-2 text-end">
                        <button class="btn btn-sm btn-outline-primary me-1" title="View details" 
                                data-bs-toggle="modal" data-bs-target="#batchDetailsModal" 
                                data-batch-id="{{ batch.id }}">
                            <i class="fas fa-search"></i>
                        </button>
                        {% if batch.status != 'In Progress' %}
                        <button class="btn btn-sm btn-outline-secondary me-1" title="Re-run training"
                                data-batch-id="{{ batch.id }}">
                            <i class="fas fa-redo"></i>
                        </button>
                        {% endif %}
                        <button class="btn btn-sm btn-outline-danger" title="Delete batch"
                                data-batch-id="{{ batch.id }}">
                            <i class="fas fa-trash"></i>
                        </button>
                    </div>
                </div>
            </div>
            {% else %}
            <div class="list-group-item py-4 text-center">
                <p class="mb-0 text-muted">No training batches found. Start by uploading documents for training.</p>
            </div>
            {% endfor %}
        </div>
    </div>
    
    <!-- Model Performance -->
    <div class="card shadow-sm mb-4">
        <div class="card-header bg-white">
            <h5 class="card-title mb-0">Model Performance by Document Type</h5>
        </div>
        <div class="card-body">
            <div class="row">
                <div class="col-md-8">
                    <div class="chart-container">
                        <canvas id="documentPerformanceChart"></canvas>
                    </div>
                </div>
                <div class="col-md-4">
                    <h6 class="section-label mb-3">Performance Insights</h6>
                    
                    <div class="card bg-light mb-3">
                        <div class="card-body p-3">
                            <h6>Strongest Categories</h6>
                            <div class="mb-2">
                                {% for category in ml_stats.strongest_categories|default([]) %}
                                <div class="d-flex justify-content-between align-items-center mb-2">
                                    <span>{{ category.name }}</span>
                                    <div class="d-flex align-items-center">
                                        <span class="me-2 text-success">{{ "%.1f"|format(category.score) }}%</span>
                                        <div class="progress" style="width: 60px; height: 5px;">
                                            <div class="progress-bar bg-success" role="progressbar" 
                                                 style="width: {{ category.score }}%;"></div>
                                        </div>
                                    </div>
                                </div>
                                {% endfor %}
                            </div>
                            
                            <h6 class="mt-3">Areas for Improvement</h6>
                            <div>
                                {% for category in ml_stats.weakest_categories|default([]) %}
                                <div class="d-flex justify-content-between align-items-center mb-2">
                                    <span>{{ category.name }}</span>
                                    <div class="d-flex align-items-center">
                                        <span class="me-2 text-danger">{{ "%.1f"|format(category.score) }}%</span>
                                        <div class="progress" style="width: 60px; height: 5px;">
                                            <div class="progress-bar bg-danger" role="progressbar" 
                                                 style="width: {{ category.score }}%;"></div>
                                        </div>
                                    </div>
                                </div>
                                {% endfor %}
                            </div>
                        </div>
                    </div>
                    
                    <div class="card border-0 bg-light">
                        <div class="card-body p-3">
                            <p class="mb-1"><strong>Recommendation:</strong></p>
                            <p class="small mb-0">
                                {% if ml_stats.recommendation %}
                                    {{ ml_stats.recommendation }}
                                {% else %}
                                    Upload more documents from categories where performance is weakest to improve overall model accuracy.
                                {% endif %}
                            </p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- New Training Modal -->
<div class="modal fade" id="newTrainingModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Start New Training Session</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <form action="{{ url_for('regulatory.start_training') }}" method="POST">
                <div class="modal-body">
                    <div class="mb-3">
                        <label for="sessionName" class="form-label">Session Name</label>
                        <input type="text" class="form-control" id="sessionName" name="session_name" required
                               placeholder="e.g., Policy Analysis Training - May 2025">
                    </div>
                    
                    <div class="row mb-3">
                        <div class="col-md-6">
                            <label for="modelType" class="form-label">Model Type</label>
                            <select class="form-select" id="modelType" name="model_type">
                                <option value="standard">Standard Model</option>
                                <option value="advanced">Advanced Model</option>
                                <option value="custom">Custom Model</option>
                            </select>
                        </div>
                        <div class="col-md-6">
                            <label for="trainingDocuments" class="form-label">Documents</label>
                            <select class="form-select" id="trainingDocuments" name="document_scope">
                                <option value="all">All Documents</option>
                                <option value="recent">Recent Documents Only</option>
                                <option value="selected">Selected Document Types</option>
                            </select>
                        </div>
                    </div>
                    
                    <div id="documentTypesContainer" class="mb-3 d-none">
                        <label class="form-label">Document Types</label>
                        <div class="row">
                            <div class="col-md-4">
                                <div class="form-check mb-2">
                                    <input class="form-check-input" type="checkbox" id="docTypePolicy" name="document_types" value="policy">
                                    <label class="form-check-label" for="docTypePolicy">Policy</label>
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="form-check mb-2">
                                    <input class="form-check-input" type="checkbox" id="docTypeCaseStudy" name="document_types" value="case_study">
                                    <label class="form-check-label" for="docTypeCaseStudy">Case Study</label>
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="form-check mb-2">
                                    <input class="form-check-input" type="checkbox" id="docTypeResearch" name="document_types" value="research">
                                    <label class="form-check-label" for="docTypeResearch">Research</label>
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="form-check mb-2">
                                    <input class="form-check-input" type="checkbox" id="docTypeStatistical" name="document_types" value="statistical">
                                    <label class="form-check-label" for="docTypeStatistical">Statistical</label>
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="form-check mb-2">
                                    <input class="form-check-input" type="checkbox" id="docTypeReport" name="document_types" value="report">
                                    <label class="form-check-label" for="docTypeReport">Report</label>
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="form-check mb-2">
                                    <input class="form-check-input" type="checkbox" id="docTypeGuidance" name="document_types" value="guidance">
                                    <label class="form-check-label" for="docTypeGuidance">Guidance</label>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="row mb-3">
                        <div class="col-md-6">
                            <label for="trainingEpochs" class="form-label">Maximum Epochs</label>
                            <input type="number" class="form-control" id="trainingEpochs" name="epochs" min="1" max="100" value="20">
                            <div class="form-text">Higher values may improve accuracy but take longer to train</div>
                        </div>
                        <div class="col-md-6">
                            <label for="batchSize" class="form-label">Batch Size</label>
                            <input type="number" class="form-control" id="batchSize" name="batch_size" min="1" max="64" value="32">
                            <div class="form-text">Lower values use less memory but may take longer to train</div>
                        </div>
                    </div>
                    
                    <div class="row mb-3">
                        <div class="col-md-6">
                            <label for="learningRate" class="form-label">Learning Rate</label>
                            <select class="form-select" id="learningRate" name="learning_rate">
                                <option value="0.001">0.001 (Default)</option>
                                <option value="0.01">0.01 (Faster)</option>
                                <option value="0.0001">0.0001 (Slower)</option>
                            </select>
                        </div>
                        <div class="col-md-6">
                            <label for="validationSplit" class="form-label">Validation Split</label>
                            <select class="form-select" id="validationSplit" name="validation_split">
                                <option value="0.2">20% (Default)</option>
                                <option value="0.1">10% (More training data)</option>
                                <option value="0.3">30% (More validation)</option>
                            </select>
                        </div>
                    </div>
                    
                    <div class="form-check mb-3">
                        <input class="form-check-input" type="checkbox" id="earlyStop" name="early_stopping" checked>
                        <label class="form-check-label" for="earlyStop">
                            Enable early stopping (automatically stop training when no improvement)
                        </label>
                    </div>
                    
                    <div class="form-check mb-3">
                        <input class="form-check-input" type="checkbox" id="saveModel" name="save_model" checked>
                        <label class="form-check-label" for="saveModel">
                            Save model after training
                        </label>
                    </div>
                    
                    <div class="form-check mb-3">
                        <input class="form-check-input" type="checkbox" id="scheduleTraining" name="schedule_training">
                        <label class="form-check-label" for="scheduleTraining">
                            Schedule training for later
                        </label>
                    </div>
                    
                    <div id="scheduleContainer" class="row mb-3 d-none">
                        <div class="col-md-6">
                            <label for="scheduleDate" class="form-label">Date</label>
                            <input type="date" class="form-control" id="scheduleDate" name="schedule_date">
                        </div>
                        <div class="col-md-6">
                            <label for="scheduleTime" class="form-label">Time</label>
                            <input type="time" class="form-control" id="scheduleTime" name="schedule_time">
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-primary">Start Training</button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Upload Documents Modal -->
<div class="modal fade" id="addDocumentsModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Upload Training Documents</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <form action="{{ url_for('regulatory.upload_training_documents') }}" method="POST" enctype="multipart/form-data" id="uploadTrainingForm">
                <div class="modal-body">
                    <p class="text-muted mb-3">Upload documents to improve model training and enhance accuracy for specific document types.</p>
                    
                    <div class="mb-3">
                        <label for="documentType" class="form-label">Document Type</label>
                        <select class="form-select" id="documentType" name="document_type" required>
                            <option value="" selected disabled>Select document type...</option>
                            <option value="policy">Policy</option>
                            <option value="case_study">Case Study</option>
                            <option value="research">Research</option>
                            <option value="statistical">Statistical</option>
                            <option value="report">Report</option>
                            <option value="guidance">Guidance</option>
                        </select>
                    </div>
                    
                    <div class="mb-3">
                        <label for="trainingCategory" class="form-label">Training Category</label>
                        <select class="form-select" id="trainingCategory" name="training_category" required>
                            <option value="" selected disabled>Select category...</option>
                            <option value="cqc">CQC (Care Quality Commission)</option>
                            <option value="riddor">RIDDOR (Reporting of Injuries)</option>
                            <option value="fire_safety">Fire Safety</option>
                            <option value="financial">Financial/Accounting</option>
                            <option value="uk_law">UK Law (General)</option>
                            <option value="uk_commercial_law">UK Commercial Law</option>
                            <option value="uk_company_law">UK Company Law</option>
                            <option value="uk_tax_law">UK Tax Law</option>
                            <option value="general">General (No specific framework)</option>
                        </select>
                    </div>
                    
                    <div class="mb-3">
                        <label class="form-label">Upload Documents</label>
                        <div class="dropzone" id="documentDropzone">
                            <input type="file" multiple class="d-none" id="documentFileInput" name="documents" required>
                            <i class="fas fa-cloud-upload-alt fa-3x mb-3 text-muted"></i>
                            <h5>Drag & Drop Files Here</h5>
                            <p class="text-muted">or click to browse</p>
                            <button type="button" class="btn btn-outline-primary" id="browseDocuments">
                                <i class="fas fa-folder-open me-1"></i> Browse Files
                            </button>
                        </div>
                    </div>
                    
                    <div id="fileList" class="d-none mb-3">
                        <h6>Selected Files:</h6>
                        <ul class="list-group" id="selectedFilesList"></ul>
                    </div>
                    
                    <div class="mb-3">
                        <label for="trainingNotes" class="form-label">Notes (Optional)</label>
                        <textarea class="form-control" id="trainingNotes" name="notes" rows="2" placeholder="Add any notes about these documents..."></textarea>
                    </div>
                    
                    <div class="form-check mb-3">
                        <input class="form-check-input" type="checkbox" id="autoAnalyze" name="auto_analyze" checked>
                        <label class="form-check-label" for="autoAnalyze">
                            Automatically analyze and tag documents
                        </label>
                    </div>
                    
                    <div class="form-check mb-3">
                        <input class="form-check-input" type="checkbox" id="includeInTraining" name="include_in_training" checked>
                        <label class="form-check-label" for="includeInTraining">
                            Include in next training session
                        </label>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-primary" id="uploadDocsBtn" disabled>Upload Documents</button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Batch Details Modal -->
<div class="modal fade" id="batchDetailsModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Training Batch Details</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div id="batchDetails">
                    <!-- Batch details will be loaded here -->
                    <div class="text-center py-5">
                        <div class="spinner-border text-primary" role="status">
                            <span class="visually-hidden">Loading...</span>
                        </div>
                        <p class="mt-3">Loading batch details...</p>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
document.addEventListener('DOMContentLoaded', function() {
    // Document Type Selection
    const trainingDocuments = document.getElementById('trainingDocuments');
    const documentTypesContainer = document.getElementById('documentTypesContainer');
    
    if (trainingDocuments) {
        trainingDocuments.addEventListener('change', function() {
            if (this.value === 'selected') {
                documentTypesContainer.classList.remove('d-none');
            } else {
                documentTypesContainer.classList.add('d-none');
            }
        });
    }
    
    // Schedule Training
    const scheduleTraining = document.getElementById('scheduleTraining');
    const scheduleContainer = document.getElementById('scheduleContainer');
    
    if (scheduleTraining) {
        scheduleTraining.addEventListener('change', function() {
            if (this.checked) {
                scheduleContainer.classList.remove('d-none');
            } else {
                scheduleContainer.classList.add('d-none');
            }
        });
    }
    
    // File Upload
    const documentDropzone = document.getElementById('documentDropzone');
    const documentFileInput = document.getElementById('documentFileInput');
    const browseDocuments = document.getElementById('browseDocuments');
    const selectedFilesList = document.getElementById('selectedFilesList');
    const fileList = document.getElementById('fileList');
    const uploadDocsBtn = document.getElementById('uploadDocsBtn');
    
    if (browseDocuments) {
        browseDocuments.addEventListener('click', function() {
            documentFileInput.click();
        });
    }
    
    if (documentFileInput) {
        documentFileInput.addEventListener('change', function() {
            handleFiles(this.files);
        });
    }
    
    if (documentDropzone) {
        // Prevent default behavior for drag and drop
        ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
            documentDropzone.addEventListener(eventName, preventDefaults, false);
        });
        
        // Highlight dropzone when file is dragged over it
        ['dragenter', 'dragover'].forEach(eventName => {
            documentDropzone.addEventListener(eventName, function() {
                documentDropzone.classList.add('dragover');
            }, false);
        });
        
        ['dragleave', 'drop'].forEach(eventName => {
            documentDropzone.addEventListener(eventName, function() {
                documentDropzone.classList.remove('dragover');
            }, false);
        });
        
        // Handle dropped files
        documentDropzone.addEventListener('drop', function(e) {
            const dt = e.dataTransfer;
            handleFiles(dt.files);
        });
    }
    
    function preventDefaults(e) {
        e.preventDefault();
        e.stopPropagation();
    }
    
    function handleFiles(files) {
        if (files.length > 0) {
            fileList.classList.remove('d-none');
            selectedFilesList.innerHTML = '';
            
            Array.from(files).forEach(file => {
                const listItem = document.createElement('li');
                listItem.className = 'list-group-item d-flex justify-content-between align-items-center';
                
                const fileInfo = document.createElement('div');
                fileInfo.innerHTML = `
                    <i class="fas fa-file-alt me-2"></i>
                    <span>${file.name}</span>
                    <small class="text-muted ms-2">${formatFileSize(file.size)}</small>
                `;
                
                listItem.appendChild(fileInfo);
                selectedFilesList.appendChild(listItem);
            });
            
            uploadDocsBtn.disabled = false;
        }
    }
    
    function formatFileSize(bytes) {
        if (bytes === 0) return '0 Bytes';
        
        const k = 1024;
        const sizes = ['Bytes', 'KB', 'MB', 'GB'];
        const i = Math.floor(Math.log(bytes) / Math.log(k));
        
        return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
    }
    
    // Charts
    // Training History Chart
    const trainingHistoryData = {{ training_history_data|safe }};
    
    if (document.getElementById('trainingHistoryChart')) {
        var trainingHistoryChart = new Chart(document.getElementById('trainingHistoryChart').getContext('2d'), {
            type: 'line',
            data: {
                labels: trainingHistoryData.labels || [],
                datasets: [
                    {
                        label: 'Training Accuracy',
                        data: trainingHistoryData.training || [],
                        borderColor: '#007bff',
                        backgroundColor: 'rgba(0, 123, 255, 0.1)',
                        fill: true,
                        tension: 0.4
                    },
                    {
                        label: 'Validation Accuracy',
                        data: trainingHistoryData.validation || [],
                        borderColor: '#28a745',
                        backgroundColor: 'transparent',
                        borderDash: [5, 5],
                        fill: false,
                        tension: 0.4
                    }
                ]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                scales: {
                    y: {
                        beginAtZero: true,
                        max: 100,
                        ticks: {
                            callback: function(value) {
                                return value + '%';
                            }
                        }
                    }
                }
            }
        });
    }
    
    // Document Performance Chart
    const documentPerformanceData = {{ document_performance_data|safe }};
    
    if (document.getElementById('documentPerformanceChart')) {
        var documentPerformanceChart = new Chart(document.getElementById('documentPerformanceChart').getContext('2d'), {
            type: 'bar',
            data: {
                labels: documentPerformanceData.labels || [],
                datasets: [{
                    label: 'Accuracy by Document Type',
                    data: documentPerformanceData.data || [],
                    backgroundColor: function(context) {
                        const value = context.dataset.data[context.dataIndex];
                        return value > 80 ? '#28a745' : value > 60 ? '#ffc107' : '#dc3545';
                    },
                    borderWidth: 1
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                scales: {
                    y: {
                        beginAtZero: true,
                        max: 100,
                        ticks: {
                            callback: function(value) {
                                return value + '%';
                            }
                        }
                    }
                }
            }
        });
    }
    
    // Batch Details Modal
    const batchDetailsModal = document.getElementById('batchDetailsModal');
    if (batchDetailsModal) {
        batchDetailsModal.addEventListener('show.bs.modal', function(event) {
            const button = event.relatedTarget;
            const batchId = button.getAttribute('data-batch-id');
            const batchDetailsContainer = document.getElementById('batchDetails');
            
            // In a real app, you would fetch batch details via AJAX here
            // For now, just simulate with a timeout
            setTimeout(function() {
                batchDetailsContainer.innerHTML = `
                    <div class="row mb-4">
                        <div class="col-md-6">
                            <h6 class="section-label">Basic Information</h6>
                            <table class="table table-sm">
                                <tr>
                                    <td><strong>Batch ID:</strong></td>
                                    <td>${batchId}</td>
                                </tr>
                                <tr>
                                    <td><strong>Name:</strong></td>
                                    <td>Training Batch ${batchId}</td>
                                </tr>
                                <tr>
                                    <td><strong>Date:</strong></td>
                                    <td>May 17, 2025</td>
                                </tr>
                                <tr>
                                    <td><strong>Status:</strong></td>
                                    <td><span class="badge bg-success">Completed</span></td>
                                </tr>
                                <tr>
                                    <td><strong>Duration:</strong></td>
                                    <td>15 minutes</td>
                                </tr>
                            </table>
                        </div>
                        <div class="col-md-6">
                            <h6 class="section-label">Performance Metrics</h6>
                            <table class="table table-sm">
                                <tr>
                                    <td><strong>Documents:</strong></td>
                                    <td>27</td>
                                </tr>
                                <tr>
                                    <td><strong>Final Accuracy:</strong></td>
                                    <td>87.5%</td>
                                </tr>
                                <tr>
                                    <td><strong>Validation Accuracy:</strong></td>
                                    <td>82.3%</td>
                                </tr>
                                <tr>
                                    <td><strong>Loss:</strong></td>
                                    <td>0.24</td>
                                </tr>
                                <tr>
                                    <td><strong>Epochs:</strong></td>
                                    <td>12/20 (Early stopping)</td>
                                </tr>
                            </table>
                        </div>
                    </div>
                    
                    <div class="mb-4">
                        <h6 class="section-label">Document Type Distribution</h6>
                        <div class="row">
                            <div class="col-md-6">
                                <div class="d-flex justify-content-between mb-2">
                                    <span>Policy:</span>
                                    <span>12 documents</span>
                                </div>
                                <div class="d-flex justify-content-between mb-2">
                                    <span>Case Study:</span>
                                    <span>5 documents</span>
                                </div>
                                <div class="d-flex justify-content-between mb-2">
                                    <span>Research:</span>
                                    <span>3 documents</span>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="d-flex justify-content-between mb-2">
                                    <span>Statistical:</span>
                                    <span>2 documents</span>
                                </div>
                                <div class="d-flex justify-content-between mb-2">
                                    <span>Report:</span>
                                    <span>3 documents</span>
                                </div>
                                <div class="d-flex justify-content-between mb-2">
                                    <span>Guidance:</span>
                                    <span>2 documents</span>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div>
                        <h6 class="section-label">Training Parameters</h6>
                        <div class="row">
                            <div class="col-md-6">
                                <div class="d-flex justify-content-between mb-2">
                                    <span>Batch Size:</span>
                                    <span>32</span>
                                </div>
                                <div class="d-flex justify-content-between mb-2">
                                    <span>Learning Rate:</span>
                                    <span>0.001</span>
                                </div>
                                <div class="d-flex justify-content-between mb-2">
                                    <span>Optimizer:</span>
                                    <span>Adam</span>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="d-flex justify-content-between mb-2">
                                    <span>Max Epochs:</span>
                                    <span>20</span>
                                </div>
                                <div class="d-flex justify-content-between mb-2">
                                    <span>Validation Split:</span>
                                    <span>20%</span>
                                </div>
                                <div class="d-flex justify-content-between mb-2">
                                    <span>Early Stopping:</span>
                                    <span>Enabled (patience: 5)</span>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
            }, 1000);
        });
    }
});
</script>
{% endblock %}