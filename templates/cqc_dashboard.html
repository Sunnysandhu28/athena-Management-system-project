{% extends "base.html" %}

{% block title %}CQC Insights Dashboard{% endblock %}

{% block content %}
<div class="container mt-4">
    <div class="row">
        <div class="col-12">
            <h1 class="mb-4">CQC Insights Dashboard</h1>

            <div class="alert {% if initialized %}alert-success{% else %}alert-warning{% endif %} mb-4">
                <h4 class="alert-heading">
                    {% if initialized %}
                    <i class="fas fa-check-circle"></i> ML System Ready
                    {% else %}
                    <i class="fas fa-exclamation-triangle"></i> ML System Initializing
                    {% endif %}
                </h4>
                <p>
                    {% if initialized %}
                    The CQC insights system is fully operational using real-world CQC report data.
                    {% else %}
                    The CQC insights system is currently using fallback patterns while data collection continues.
                    {% endif %}
                </p>
            </div>

            <div class="row mb-4">
                <div class="col-md-4">
                    <div class="card h-100">
                        <div class="card-header bg-primary text-white">
                            <h5 class="card-title mb-0">
                                <i class="fas fa-file-alt"></i> Document Analysis
                            </h5>
                        </div>
                        <div class="card-body">
                            <p class="card-text">
                                Analyze documents against CQC standards with ML-enhanced insights focusing on governance, staffing, and training regulations.
                            </p>
                            <a href="#analyze-document" class="btn btn-primary stretched-link" data-toggle="modal" data-target="#analyzeModal">
                                Analyze Document
                            </a>
                        </div>
                    </div>
                </div>

                <div class="col-md-4">
                    <div class="card h-100">
                        <div class="card-header bg-success text-white">
                            <h5 class="card-title mb-0">
                                <i class="fas fa-clipboard-check"></i> Inspection Templates
                            </h5>
                        </div>
                        <div class="card-body">
                            <p class="card-text">
                                Generate comprehensive inspection templates based on authentic CQC inspection patterns and regulatory focus areas.
                            </p>
                            <a href="{{ url_for('cqc.inspection_template') }}" class="btn btn-success stretched-link">
                                Create Template
                            </a>
                        </div>
                    </div>
                </div>

                <div class="col-md-4">
                    <div class="card h-100">
                        <div class="card-header bg-info text-white">
                            <h5 class="card-title mb-0">
                                <i class="fas fa-lightbulb"></i> Regulatory Insights
                            </h5>
                        </div>
                        <div class="card-body">
                            <p class="card-text">
                                Access ML-powered insights on specific regulatory areas using patterns from authentic CQC reports.
                            </p>
                            <a href="{{ url_for('cqc.regulatory_insights') }}" class="btn btn-info stretched-link">
                                Get Insights
                            </a>
                        </div>
                    </div>
                </div>
            </div>

            <div class="card mb-4">
                <div class="card-header bg-dark text-white">
                    <h5 class="card-title mb-0">
                        <i class="fas fa-brain"></i> ML-Powered Insights System
                    </h5>
                </div>
                <div class="card-body">
                    <h5>How It Works</h5>
                    <p>
                        Our ML system analyzes authentic CQC reports to understand regulatory patterns and expectations, particularly focusing on governance, staffing, and training regulations.
                    </p>

                    <div class="row mt-4">
                        <div class="col-md-6">
                            <div class="card h-100">
                                <div class="card-header">
                                    <h6 class="mb-0">Key Features</h6>
                                </div>
                                <div class="card-body">
                                    <ul class="list-group list-group-flush">
                                        <li class="list-group-item">
                                            <i class="fas fa-check-circle text-success"></i> 
                                            Pattern recognition from real CQC reports
                                        </li>
                                        <li class="list-group-item">
                                            <i class="fas fa-check-circle text-success"></i> 
                                            Regulatory analysis following CQC methodology
                                        </li>
                                        <li class="list-group-item">
                                            <i class="fas fa-check-circle text-success"></i> 
                                            Focus on key regulatory areas (governance, staffing, training)
                                        </li>
                                        <li class="list-group-item">
                                            <i class="fas fa-check-circle text-success"></i> 
                                            Authentic language patterns from CQC inspectors
                                        </li>
                                        <li class="list-group-item">
                                            <i class="fas fa-check-circle text-success"></i> 
                                            Rating-specific insights (Outstanding to Inadequate)
                                        </li>
                                    </ul>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="card h-100">
                                <div class="card-header">
                                    <h6 class="mb-0">Data Sources</h6>
                                </div>
                                <div class="card-body">
                                    <ul class="list-group list-group-flush">
                                        <li class="list-group-item">
                                            <i class="fas fa-database text-primary"></i> 
                                            1,000+ authentic CQC reports from care homes
                                        </li>
                                        <li class="list-group-item">
                                            <i class="fas fa-database text-primary"></i> 
                                            Focused analysis of regulatory sections
                                        </li>
                                        <li class="list-group-item">
                                            <i class="fas fa-database text-primary"></i> 
                                            Reports across all rating categories
                                        </li>
                                        <li class="list-group-item">
                                            <i class="fas fa-database text-primary"></i> 
                                            Authentic rating-specific language patterns
                                        </li>
                                        <li class="list-group-item">
                                            <i class="fas fa-database text-primary"></i> 
                                            Pattern matching with official CQC terminology
                                        </li>
                                    </ul>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Document Analysis Modal -->
<div class="modal fade" id="analyzeModal" tabindex="-1" role="dialog" aria-labelledby="analyzeModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg" role="document">
        <div class="modal-content">
            <div class="modal-header bg-primary text-white">
                <h5 class="modal-title" id="analyzeModalLabel">
                    <i class="fas fa-file-alt"></i> Analyze Document Against CQC Standards
                </h5>
                <button type="button" class="close text-white" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <form action="{{ url_for('cqc.analyze_document') }}" method="post" id="analyze-form">
                <div class="modal-body">
                    <div class="form-group">
                        <label for="document_text">Paste Document Text:</label>
                        <textarea class="form-control" id="document_text" name="document_text" rows="10" required></textarea>
                        <small class="form-text text-muted">
                            Paste text from policies, procedures, reports, or other documents for CQC regulatory analysis.
                        </small>
                    </div>
                    <div class="form-group">
                        <label>Focus Areas:</label>
                        <div class="custom-control custom-checkbox">
                            <input type="checkbox" class="custom-control-input" id="governance" name="focus_areas" value="governance" checked>
                            <label class="custom-control-label" for="governance">Governance</label>
                        </div>
                        <div class="custom-control custom-checkbox">
                            <input type="checkbox" class="custom-control-input" id="staffing" name="focus_areas" value="staffing" checked>
                            <label class="custom-control-label" for="staffing">Staffing</label>
                        </div>
                        <div class="custom-control custom-checkbox">
                            <input type="checkbox" class="custom-control-input" id="training" name="focus_areas" value="training" checked>
                            <label class="custom-control-label" for="training">Training</label>
                        </div>
                        <div class="custom-control custom-checkbox">
                            <input type="checkbox" class="custom-control-input" id="medication" name="focus_areas" value="medication">
                            <label class="custom-control-label" for="medication">Medication</label>
                        </div>
                        <div class="custom-control custom-checkbox">
                            <input type="checkbox" class="custom-control-input" id="infection_control" name="focus_areas" value="infection control">
                            <label class="custom-control-label" for="infection_control">Infection Control</label>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-primary">
                        <i class="fas fa-search"></i> Analyze
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<script>
    // Redirect to results page after form submission
    $('#analyze-form').submit(function(e) {
        e.preventDefault();
        
        $.ajax({
            type: 'POST',
            url: $(this).attr('action'),
            data: $(this).serialize(),
            success: function(response) {
                if (response.success) {
                    window.location.href = "{{ url_for('cqc.analysis_results') }}";
                } else {
                    alert('Error: ' + response.error);
                }
            },
            error: function() {
                alert('An error occurred during analysis.');
            }
        });
    });
</script>
{% endblock %}