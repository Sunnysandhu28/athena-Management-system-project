{% extends "base.html" %}

{% block title %}{{ policy.title }}{% endblock %}

{% block styles %}
{{ super() }}
<style>
    .policy-content {
        font-family: 'Times New Roman', Times, serif;
        line-height: 1.6;
    }
    
    .policy-content h1 {
        font-size: 1.8em;
        margin-top: 1.5em;
        margin-bottom: 0.8em;
        color: #2c3e50;
    }
    
    .policy-content h2 {
        font-size: 1.5em;
        margin-top: 1.2em;
        margin-bottom: 0.6em;
        color: #34495e;
    }
    
    .policy-content h3 {
        font-size: 1.3em;
        margin-top: 1em;
        margin-bottom: 0.5em;
        color: #2c3e50;
    }
    
    .policy-content p {
        margin-bottom: 0.8em;
    }
    
    .policy-content ul, .policy-content ol {
        margin-bottom: 1em;
        padding-left: 2em;
    }
    
    .policy-header {
        text-align: center;
        margin-bottom: 2em;
        padding-bottom: 1em;
        border-bottom: 1px solid #eee;
    }
    
    .policy-meta {
        font-size: 0.9em;
        color: #7f8c8d;
    }
    
    @media print {
        .no-print {
            display: none;
        }
        
        body {
            font-size: 12pt;
        }
        
        .container {
            width: 100%;
            max-width: none;
            padding: 0;
            margin: 0;
        }
        
        .policy-content {
            padding: 0;
            margin: 0;
        }
    }
</style>
{% endblock %}

{% block content %}
<div class="container mt-4">
    <div class="row no-print">
        <div class="col-12">
            <nav aria-label="breadcrumb">
                <ol class="breadcrumb">
                    <li class="breadcrumb-item"><a href="{{ url_for('index') }}">Home</a></li>
                    <li class="breadcrumb-item"><a href="{{ url_for('policy_ai.policy_learning') }}">Policy Learning</a></li>
                    <li class="breadcrumb-item"><a href="{{ url_for('policy_ai.generate_policy_route') }}">Generate Policy</a></li>
                    <li class="breadcrumb-item active" aria-current="page">View Policy</li>
                </ol>
            </nav>
        </div>
    </div>
    
    <div class="row no-print mb-4">
        <div class="col-12">
            <div class="btn-toolbar justify-content-between" role="toolbar">
                <div class="btn-group" role="group">
                    <a href="{{ url_for('policy_ai.generate_policy_route') }}" class="btn btn-secondary">
                        <i class="fas fa-arrow-left mr-1"></i> Back
                    </a>
                    <button onclick="window.print()" class="btn btn-info">
                        <i class="fas fa-print mr-1"></i> Print
                    </button>
                </div>
                
                <div class="btn-group" role="group">
                    <button onclick="exportToPDF()" class="btn btn-primary">
                        <i class="fas fa-file-pdf mr-1"></i> Export to PDF
                    </button>
                    <button onclick="importToDatabase()" class="btn btn-success" id="importBtn">
                        <i class="fas fa-database mr-1"></i> Save to Database
                    </button>
                </div>
            </div>
        </div>
    </div>
    
    <div class="row">
        <div class="col-12">
            <div class="card">
                <div class="card-body policy-content">
                    <!-- Policy Header -->
                    <div class="policy-header">
                        <h1>{{ policy.title }}</h1>
                        {% if policy.reference_code %}
                            <p><strong>Reference:</strong> {{ policy.reference_code }}</p>
                        {% endif %}
                        {% if policy.organization_name %}
                            <p><strong>Organization:</strong> {{ policy.organization_name }}</p>
                        {% endif %}
                        <p class="policy-meta">
                            <strong>Category:</strong> {{ policy.category }}
                            <span class="mx-2">|</span>
                            <strong>Generated:</strong> {{ policy.generated_at }}
                        </p>
                    </div>
                    
                    <!-- Policy Content -->
                    {{ policy.content|safe }}
                    
                    <!-- Policy Footer -->
                    <div class="mt-5 pt-3 border-top">
                        <p class="policy-meta text-center">
                            <em>This policy was generated by AI using patterns learned from professional healthcare policies.</em>
                        </p>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Learning Information - Hidden on Print -->
    <div class="row mt-4 no-print">
        <div class="col-12">
            <div class="card">
                <div class="card-header bg-info text-white">
                    <h5>Policy Learning Information</h5>
                </div>
                <div class="card-body">
                    <p>This policy was generated using AI analysis of existing policy structures and patterns.</p>
                    
                    {% if policy.structure %}
                        <h6>Structure Source</h6>
                        <p>
                            {% if policy.structure.structure.source == 'template' %}
                                Structure based on template from {{ policy.structure.site_types_used|join(', ') }} policies.
                            {% else %}
                                Structure generated from common sections across {{ policy.structure.site_types_used|join(', ') }} policies.
                            {% endif %}
                        </p>
                        
                        <h6>Common Sections Used</h6>
                        <ul>
                            {% for section in policy.structure.common_sections[:5] %}
                                <li>{{ section }}</li>
                            {% endfor %}
                        </ul>
                        
                        {% if policy.structure.terminology_recommendations %}
                            <h6>Terminology Applied</h6>
                            <ul>
                                {% for term in policy.structure.terminology_recommendations[:3] %}
                                    <li>{{ term.term }}</li>
                                {% endfor %}
                            </ul>
                        {% endif %}
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
{{ super() }}
<script>
    function exportToPDF() {
        // Placeholder for PDF export functionality
        alert('PDF export functionality will be implemented');
    }
    
    function importToDatabase() {
        const importBtn = document.getElementById('importBtn');
        importBtn.disabled = true;
        importBtn.innerHTML = '<i class="fas fa-spinner fa-spin mr-1"></i> Saving...';
        
        // Call the API to import the policy
        fetch('{{ url_for("policy_ai.import_policy_to_db", policy_id=policy.id) }}', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            }
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                alert('Policy successfully saved to database!');
                importBtn.innerHTML = '<i class="fas fa-check mr-1"></i> Saved to Database';
                importBtn.classList.remove('btn-success');
                importBtn.classList.add('btn-secondary');
            } else {
                alert('Error saving policy: ' + data.error);
                importBtn.disabled = false;
                importBtn.innerHTML = '<i class="fas fa-database mr-1"></i> Try Again';
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('Error saving policy: ' + error);
            importBtn.disabled = false;
            importBtn.innerHTML = '<i class="fas fa-database mr-1"></i> Try Again';
        });
    }
</script>
{% endblock %}